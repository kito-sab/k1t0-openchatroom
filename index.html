<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenChat + LiveTalk</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background:#0f1220;
  color:#f1f1f5;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}
.card{
  background:#1c1f35;
  border:none;
  border-radius:14px;
}
#chat{
  height:60vh;
  overflow-y:auto;
  background:#121426;
  border-radius:12px;
  padding:10px;
}
.msg{
  background:#2f3142;
  color:#f1f1f5;
  padding:8px 12px;
  border-radius:12px;
  margin-bottom:6px;
  max-width:80%;
}
.msg.me{
  background:#4f6cff;
  margin-left:auto;
  color:white;
}
.user{
  padding:8px;
  border-radius:10px;
  background:#2f3142;
  margin-bottom:6px;
}
.user.talking{
  background:#22c55e;
  box-shadow:0 0 10px #22c55e;
}
#callMini{
  cursor:pointer;
}
button{
  border-radius:10px!important;
}
</style>
</head>

<body class="p-2">

<!-- ğŸ“ é€šè©±ãƒŸãƒ‹è¡¨ç¤º -->
<div id="callMini"
 class="position-fixed top-0 end-0 m-3 px-3 py-2 bg-success rounded shadow"
 style="display:none;"
 onclick="openCallScreen()">
ğŸ“ é€šè©±ä¸­
</div>

<div class="container">

<!-- ğŸ‘¤ åå‰å…¥åŠ› -->
<div id="nameScreen" class="card p-4 text-center">
  <h4 class="mb-3">åå‰ã‚’å…¥åŠ›</h4>
  <input id="nameInput" class="form-control mb-3" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
  <button class="btn btn-primary w-100" onclick="setName()">å…¥å®¤</button>
</div>

<!-- ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ -->
<div id="chatScreen" style="display:none;">
  <div class="card p-3 mb-2">
    <div id="chat"></div>
  </div>

  <div class="input-group mb-2">
    <input id="textInput" class="form-control" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
    <button class="btn btn-primary" onclick="sendMessage()">é€ä¿¡</button>
  </div>

  <button class="btn btn-success w-100" onclick="startCall()">ğŸ™ï¸ ãƒ©ã‚¤ãƒ–ãƒˆãƒ¼ã‚¯é–‹å§‹</button>
</div>

<!-- ğŸ™ï¸ é€šè©± -->
<div id="callScreen" style="display:none;">
  <button class="btn btn-secondary mb-2" onclick="backToChat()">â† æˆ»ã‚‹</button>
  <h5 class="mb-2">ğŸ™ï¸ ãƒ©ã‚¤ãƒ–ãƒˆãƒ¼ã‚¯</h5>
  <div id="callCount" class="mb-2"></div>
  <div id="callUsers"></div>
  <button class="btn btn-warning w-100 mt-2" onclick="toggleMute()">ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿</button>
</div>

</div>

<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  onSnapshot, doc, deleteDoc, setDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getAuth, signInAnonymously }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

/* ğŸ”§ Firebase è¨­å®šï¼ˆã‚³ãƒ”ãƒ¼ã—ãŸã‚„ã¤ï¼‰ */
const firebaseConfig = {
  apiKey: "AIzaSyBPF10dmMuhpldA1wkqS71xxS6FSq-1zNM",
  authDomain: "openchat-5f617.firebaseapp.com",
  projectId: "openchat-5f617",
  storageBucket: "openchat-5f617.firebasestorage.app",
  messagingSenderId: "505527641308",
  appId: "1:505527641308:web:7bea07787102ab2b394019",
  measurementId: "G-NQV761BZXS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

/* ========= çŠ¶æ…‹ ========= */
let userName = "";
let uid = "";
let localStream, audioTrack;
const callId = "room1";

/* ========= èªè¨¼ ========= */
await signInAnonymously(auth);
uid = auth.currentUser.uid;

/* ========= åå‰ ========= */
window.setName = () => {
  userName = nameInput.value.trim();
  if(!userName) return;

  nameScreen.style.display="none";
  chatScreen.style.display="block";
};

/* ========= ãƒãƒ£ãƒƒãƒˆ ========= */
window.sendMessage = async () => {
  if(!textInput.value) return;

  await addDoc(collection(db,"messages"),{
    text: textInput.value,
    name: userName,
    uid: uid,
    time: serverTimestamp()
  });
  textInput.value="";
};

const msgQuery = query(
  collection(db,"messages"),
  orderBy("time")
);

onSnapshot(msgQuery, snap=>{
  chat.innerHTML="";
  snap.forEach(d=>{
    const m=d.data();
    const div=document.createElement("div");
    div.className="msg"+(m.uid===uid?" me":"");
    div.innerHTML = `
      <div><b>${m.name}</b></div>
      <div>${m.text}</div>
      ${m.uid===uid?`<button class="btn btn-sm btn-danger mt-1" onclick="delMsg('${d.id}')">å‰Šé™¤</button>`:""}
    `;
    chat.appendChild(div);
  });
  chat.scrollTop = chat.scrollHeight;
});

window.delMsg = id => deleteDoc(doc(db,"messages",id));

/* ========= é€šè©± ========= */
window.startCall = async ()=>{
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioTrack = localStream.getAudioTracks()[0];
  detectTalking();
  chatScreen.style.display="none";
  callScreen.style.display="block";
};

window.backToChat = ()=>{
  callScreen.style.display="none";
  chatScreen.style.display="block";
  callMini.style.display="block";
};

window.openCallScreen = ()=>{
  callMini.style.display="none";
  chatScreen.style.display="none";
  callScreen.style.display="block";
};

window.toggleMute = ()=>{
  audioTrack.enabled = !audioTrack.enabled;
};

/* ========= ç™ºè©±æ¤œçŸ¥ ========= */
function detectTalking(){
  const ctx=new AudioContext();
  const analyser=ctx.createAnalyser();
  const src=ctx.createMediaStreamSource(localStream);
  src.connect(analyser);
  const data=new Uint8Array(analyser.frequencyBinCount);

  const loop=async()=>{
    analyser.getByteFrequencyData(data);
    const vol=data.reduce((a,b)=>a+b)/data.length;
    await setDoc(doc(db,"calls",callId,"users",uid),{
      name:userName,
      talking:vol>25
    });
    requestAnimationFrame(loop);
  };
  loop();
}

/* ========= å‚åŠ è€… ========= */
onSnapshot(collection(db,"calls",callId,"users"),snap=>{
  callUsers.innerHTML="";
  callCount.innerText=`å‚åŠ ä¸­ï¼š${snap.size}äºº`;
  snap.forEach(d=>{
    const u=d.data();
    const div=document.createElement("div");
    div.className="user"+(u.talking?" talking":"");
    div.textContent = u.name + (u.talking?" ğŸ¤":"");
    callUsers.appendChild(div);
  });
});
</script>

</body>
</html>
