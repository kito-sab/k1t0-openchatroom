<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Open Chat + Live Talk</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f5f5f5; }
#chat { height:60vh; overflow-y:auto; background:white; padding:10px; border-radius:10px; }
.msg { margin-bottom:6px; }
.msg.me { text-align:right; }
.user {
  padding:6px;
  border-radius:8px;
  margin:4px 0;
  background:#eee;
}
.user.talking {
  background:#4caf50;
  color:white;
  box-shadow:0 0 10px #4caf50;
}
#callMini { cursor:pointer; }
</style>
</head>

<body class="p-2">

<!-- ğŸ“ é€šè©±ä¸­ãƒŸãƒ‹ãƒãƒ¼ -->
<div id="callMini"
 class="position-fixed top-0 end-0 m-2 p-2 bg-success text-white rounded shadow"
 style="display:none;"
 onclick="openCallScreen()">
ğŸ“ é€šè©±ä¸­
</div>

<!-- ğŸ‘¤ åå‰å…¥åŠ› -->
<div id="nameScreen">
  <h4>åå‰ã‚’å…¥åŠ›</h4>
  <input id="nameInput" class="form-control mb-2">
  <button class="btn btn-primary" onclick="setName()">å…¥å®¤</button>
</div>

<!-- ğŸ’¬ ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
<div id="chatScreen" style="display:none;">
  <div id="chat"></div>

  <div class="input-group mt-2">
    <input id="textInput" class="form-control" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
    <button class="btn btn-primary" onclick="sendMessage()">é€ä¿¡</button>
  </div>

  <button class="btn btn-success mt-2" onclick="startCall()">ğŸ“ ãƒ©ã‚¤ãƒ–ãƒˆãƒ¼ã‚¯é–‹å§‹</button>
</div>

<!-- ğŸ™ï¸ é€šè©±ç”»é¢ -->
<div id="callScreen" style="display:none;">
  <button class="btn btn-secondary mb-2" onclick="backToChat()">â† æˆ»ã‚‹</button>
  <h5>ğŸ™ï¸ ãƒ©ã‚¤ãƒ–ãƒˆãƒ¼ã‚¯</h5>
  <div id="callCount" class="fw-bold mb-2"></div>
  <div id="callUsers"></div>
  <button class="btn btn-warning mt-2" onclick="toggleMute()">ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
</div>

<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp,
         onSnapshot, doc, deleteDoc, setDoc } from
"https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getAuth, signInAnonymously } from
"https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

/* ğŸ”§ è‡ªåˆ†ã®Firebaseè¨­å®š */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

/* ========= å¤‰æ•° ========= */
let userName = "";
let uid = "";
let localStream, audioTrack;
let isCalling = false;
const callId = "room1";

/* ========= èªè¨¼ ========= */
await signInAnonymously(auth);
uid = auth.currentUser.uid;

/* ========= åå‰è¨­å®š ========= */
window.setName = () => {
  userName = nameInput.value;
  if (!userName) return;

  nameScreen.style.display = "none";
  chatScreen.style.display = "block";
};

/* ========= ãƒãƒ£ãƒƒãƒˆ ========= */
window.sendMessage = async () => {
  if (!textInput.value) return;

  await addDoc(collection(db,"messages"),{
    text:textInput.value,
    name:userName,
    uid:uid,
    time:serverTimestamp()
  });
  textInput.value = "";
};

onSnapshot(collection(db,"messages"), snap=>{
  chat.innerHTML = "";
  snap.forEach(d=>{
    const m = d.data();
    const div = document.createElement("div");
    div.className = "msg " + (m.uid===uid?"me":"");
    div.innerHTML =
      `<b>${m.name}</b>: ${m.text}` +
      (m.uid===uid ? ` <button onclick="delMsg('${d.id}')">ğŸ—‘ï¸</button>`:"");
    chat.appendChild(div);
  });
  chat.scrollTop = chat.scrollHeight;
});

window.delMsg = id => deleteDoc(doc(db,"messages",id));

/* ========= é€šè©± ========= */
window.startCall = async () => {
  if (!isCalling) {
    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioTrack = localStream.getAudioTracks()[0];
    startTalkingDetect();
    isCalling = true;
  }
  chatScreen.style.display="none";
  callScreen.style.display="block";
};

window.backToChat = () => {
  callScreen.style.display="none";
  chatScreen.style.display="block";
  callMini.style.display="block";
};

window.openCallScreen = () => {
  callMini.style.display="none";
  chatScreen.style.display="none";
  callScreen.style.display="block";
};

window.toggleMute = () => {
  audioTrack.enabled = !audioTrack.enabled;
};

/* ========= ç™ºè©±æ¤œçŸ¥ ========= */
function startTalkingDetect(){
  const ctx = new AudioContext();
  const analyser = ctx.createAnalyser();
  const src = ctx.createMediaStreamSource(localStream);
  src.connect(analyser);
  const data = new Uint8Array(analyser.frequencyBinCount);

  const loop = async ()=>{
    analyser.getByteFrequencyData(data);
    const vol = data.reduce((a,b)=>a+b)/data.length;
    await setDoc(doc(db,"calls",callId,"users",uid),{
      name:userName,
      talking:vol>20
    });
    requestAnimationFrame(loop);
  };
  loop();
}

/* ========= å‚åŠ è€…è¡¨ç¤º ========= */
onSnapshot(collection(db,"calls",callId,"users"), snap=>{
  callUsers.innerHTML="";
  callCount.innerText=`å‚åŠ ä¸­ï¼š${snap.size}äºº`;
  snap.forEach(d=>{
    const u=d.data();
    const div=document.createElement("div");
    div.className="user"+(u.talking?" talking":"");
    div.innerText=u.name+(u.talking?" ğŸ¤":"");
    callUsers.appendChild(div);
  });
});
</script>

</body>
</html>
